# Plan States and Status Lines

This document describes how the Overview tab derives device state and the status text shown per device.
Only managed devices are included in the plan snapshot; unmanaged devices are hidden from the Overview tab.

## Core State Fields (per device)

- currentState: "on" | "off" | "unknown" | "not_applicable"
  - Derived from device on/off state when available. `not_applicable` is used for temperature-only devices without `onoff`.
- plannedState: "keep" | "shed"
  - "keep" means allow device to stay in its current state or restore if off.
  - "shed" means device should be off or set to its shed temperature.
- shedAction: "turn_off" | "set_temperature"
- shedTemperature: number | null
- plannedTarget: number | null (target temperature if applicable)
- reason: string (shown as the Status line in the Overview tab)

## State Transitions (high level)

- Normal active (plannedState = "keep"):
  - plannedState = "keep"
  - reason = "keep" (or "keep (recently restored)")
- Shedding due to overshoot:
  - If headroom < 0, lowest-priority devices are added to shedSet.
  - plannedState = "shed", reason reflects the active cap:
    - "shed due to capacity"
    - "shed due to daily budget"
    - "shed due to daily budget + capacity"
- Hourly budget exhausted:
  - plannedState = "shed"
  - reason = "shed due to hourly budget"
- Device is off and can be restored:
  - If not in shortfall and enough headroom:
    - plannedState = "keep"
    - reason = "restore (need XkW, headroom YkW)"
  - If in shortfall:
    - plannedState = "shed"
    - reason = "shortfall (need XkW, headroom YkW)"
    - Note: this headroom is operational plan headroom (effective soft limit context), while shortfall entry itself is based on projected hourly hard-cap budget breach.
- Cooldown / stabilization:
  - After shedding or restoring, restoration is throttled.
  - plannedState = "shed"
  - reason = cooldown or stabilization messages (see list below).
- Swap-based restore:
  - If a higher-priority device needs restore but headroom is insufficient:
    - Lower-priority on devices are marked "shed" to free headroom.
    - The higher-priority device becomes a pending swap target until restored.

## Overview Tab "State" Line (UI)

The Overview tab shows a State line derived from plannedState and currentState:

- Shed (powered off): plannedState === "shed" and shedAction === "turn_off"
- Shed (lowered temperature): plannedState === "shed" and shedAction === "set_temperature"
- Restoring: plannedState === "keep" and currentState is "off" or "unknown"
- Active: plannedState === "keep" and currentState is "on"
- Active (temperature-managed): plannedState === "keep" and currentState is "not_applicable"
- Capacity control off: controllable === false
- Unknown: fallback if state is not clear

## Overview Tab "Status" Line (reason values)

These are the main reason strings generated by the planner. The UI shows reason or "Waiting for headroom".
Parentheses indicate dynamic values.

- keep
- keep (recently restored)
- capacity control off
- restore (need XkW, headroom YkW)
- shed due to capacity
- shed due to daily budget
- shed due to daily budget + capacity
- shed due to hourly budget
- shortfall (need XkW, headroom YkW)
- cooldown (shedding, Ss remaining)
- cooldown (restore, Ss remaining)
- swap pending
- swap pending (NAME)
- swapped out for NAME
- insufficient headroom (need XkW, headroom YkW)
- shedding active
- restore throttled

## State vs Status

The State line carries the on/off vs shed distinction (including "Shed (powered off)" vs "Shed (lowered temperature)").
Status lines are now simplified and avoid repeating the state, focusing on why the device is blocked or changing.

## Notes on min-temperature shedding

Devices configured with shedAction "set_temperature" are still marked as plannedState "shed".
They share the same reason strings as turn-off shedding, including "shortfall (need XkW, headroom YkW)" when in shortfall.
