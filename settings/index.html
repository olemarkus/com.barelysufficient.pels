<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PELS Control Panel</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <main class="screen">
    <header class="hero">
      <p class="eyebrow">PELS ¬∑ App control</p>
      <h1>Control center</h1>
      <p class="lede">Manage devices, modes, budgets, and usage.</p>
      <div class="tabs" role="tablist">
        <button class="tab active" data-tab="overview" role="tab" aria-selected="true">Overview</button>
        <button class="tab" data-tab="devices" role="tab" aria-selected="false">Devices</button>
        <button class="tab" data-tab="modes" role="tab" aria-selected="false">Modes</button>
        <button class="tab" data-tab="budget" role="tab" aria-selected="false">Budget</button>
        <button class="tab" data-tab="usage" role="tab" aria-selected="false">Usage</button>
        <button class="tab" data-tab="price" role="tab" aria-selected="false">Price</button>
        <button class="tab" data-tab="advanced" role="tab" aria-selected="false">Advanced</button>
      </div>
    </header>

    <div id="dry-run-banner" class="banner banner--warning" hidden>
      <span class="banner__icon">‚ö†Ô∏è</span>
      <span class="banner__text">Dry-run mode is enabled. Devices will not be switched automatically.</span>
    </div>

    <div id="stale-data-banner" class="banner banner--warning" hidden>
      <span class="banner__icon">‚ö†Ô∏è</span>
      <span id="stale-data-text" class="banner__text">No power data received recently. Check your Flow that reports power usage.</span>
    </div>

    <section class="card panel hidden" id="devices-panel" data-panel="devices">
      <div class="card__header">
        <div>
          <p class="eyebrow">Devices</p>
          <h2>Device control</h2>
        </div>
      </div>
      <div class="toggle-row">
        <label class="toggle-label">
          <input id="capacity-dry-run" name="capacity_dry_run" type="checkbox" checked>
          <span>Disable device control (dry run)</span>
        </label>
        <small class="field__hint">PELS will only monitor devices while this is enabled.</small>
      </div>
      <div class="device-table-header">
        <span>Device</span>
        <span data-tooltip="Managed by PELS">Managed</span>
        <span data-tooltip="Capacity-based control">Cap</span>
        <span data-tooltip="Price-based control">Price</span>
      </div>
      <div id="device-list" class="device-list" role="list"></div>
      <p id="empty-state" class="muted" hidden>No devices with target temperature capabilities were found.</p>
      <div class="list__footer">
        <button type="button" class="btn secondary" id="refresh-button">Refresh</button>
        <p class="muted">Managed devices participate in modes and optimization. Temperature & priority live in the Modes tab.</p>
      </div>
    </section>

    <section class="card panel hidden" id="modes-panel" data-panel="modes">
      <div class="card__header">
        <div>
          <p class="eyebrow">Modes</p>
          <h2>Per-mode priorities & temperatures</h2>
        </div>
      </div>
      <div class="form-grid form-inline">
        <label class="field">
          <span class="field__label">Active mode</span>
          <select id="active-mode-select" name="active_mode"></select>
          <small class="field__hint">Changes apply immediately.</small>
        </label>
      </div>
      <form id="priority-form" class="form-grid">
        <label class="field">
          <span class="field__label">Edit mode</span>
          <select id="mode-select" name="mode"></select>
          <div class="inline-actions">
            <input id="mode-new" type="text" placeholder="New mode name">
            <button type="button" class="btn secondary" id="add-mode-button">Add</button>
            <button type="button" class="btn ghost" id="delete-mode-button">Delete</button>
            <button type="button" class="btn ghost" id="rename-mode-button">Rename</button>
          </div>
          <small class="field__hint">Drag to reorder priorities (top = keep on longest). Set desired temps per mode.</small>
        </label>
        <div id="priority-list" class="device-list tight-list" role="list"></div>
        <p id="priority-empty" class="muted" hidden>No controllable devices found. Refresh devices first.</p>
      </form>
      <p class="muted">Tip: Drag to reorder priorities (auto-saves). Temperatures save automatically when changed.</p>
    </section>

    <section class="card panel hidden" id="budget-panel" data-panel="budget">
      <div class="card__header">
        <div>
          <p class="eyebrow">Budget</p>
          <h2>Capacity & daily budget</h2>
        </div>
      </div>
      <details class="settings-collapse" open>
        <summary>
          <h3 class="section-title">‚ö° Capacity</h3>
          <span class="section-hint">Hourly kW cap</span>
        </summary>
        <div class="collapse-content">
          <form id="capacity-form" class="form-grid">
            <label class="field">
              <span class="field__label">Capacity limit (kW)</span>
              <input id="capacity-limit" name="capacity_limit" type="number" step="0.1" min="0" inputmode="decimal" autocomplete="off" required>
            </label>
            <label class="field">
              <span class="field__label">Soft margin (kW)</span>
              <input id="capacity-margin" name="capacity_margin" type="number" step="0.05" min="0" inputmode="decimal" autocomplete="off" required>
              <small class="field__hint">Soft limit = limit - margin.</small>
            </label>
          </form>
        </div>
      </details>

      <details class="settings-collapse" open>
        <summary>
          <h3 class="section-title">üìÜ Daily budget</h3>
          <span class="section-hint">Soft kWh/day guide</span>
        </summary>
        <div class="collapse-content">
          <form id="daily-budget-form" class="form-grid">
            <label class="field checkbox-field">
              <input id="daily-budget-enabled" name="daily_budget_enabled" type="checkbox">
              <span class="field__label">Enable daily energy budget</span>
            </label>
            <label class="field">
              <span class="field__label">Daily budget (kWh)</span>
              <input id="daily-budget-kwh" name="daily_budget_kwh" type="number" step="0.1" inputmode="decimal" autocomplete="off">
              <small class="field__hint">Daily energy target used to build the plan.</small>
            </label>
            <label class="field checkbox-field">
              <input id="daily-budget-price-shaping" name="daily_budget_price_shaping_enabled" type="checkbox" checked>
              <span class="field__label">Price-shape today plan</span>
            </label>
          </form>

          <div class="daily-budget-header">
            <div>
              <h4 id="daily-budget-title">Today plan</h4>
              <p class="muted" id="daily-budget-day">--</p>
            </div>
            <div class="daily-budget-actions">
              <div class="daily-budget-toggle" role="group" aria-label="Daily budget view">
                <button type="button" class="daily-budget-toggle__button is-active" id="daily-budget-toggle-today" aria-pressed="true">Today</button>
                <button type="button" class="daily-budget-toggle__button" id="daily-budget-toggle-tomorrow" aria-pressed="false">Tomorrow</button>
              </div>
              <div class="pill" id="daily-budget-status-pill">No data</div>
            </div>
          </div>

          <div class="usage-summary daily-budget-summary">
            <div class="summary-card">
              <span class="summary-label">Remaining</span>
              <span class="summary-value" id="daily-budget-remaining">-- kWh</span>
            </div>
            <div class="summary-card">
              <span class="summary-label">Deviation</span>
              <span class="summary-value" id="daily-budget-deviation">-- kWh</span>
            </div>
            <div class="summary-card">
              <span class="summary-label" id="daily-budget-cost-label">Estimated cost</span>
              <span class="summary-value" id="daily-budget-cost">-- kr</span>
            </div>
          </div>

          <div id="daily-budget-chart" class="daily-budget-chart">
            <div class="daily-budget-bars-wrap">
              <div id="daily-budget-bars" class="daily-budget-bars"></div>
            </div>
            <div id="daily-budget-labels" class="daily-budget-labels"></div>
          </div>

          <div class="daily-budget-legend" id="daily-budget-legend">
            <div class="daily-budget-legend__item">
              <span class="daily-budget-legend__swatch daily-budget-legend__swatch--planned" aria-hidden="true"></span>
              <span class="muted">Planned</span>
            </div>
            <div class="daily-budget-legend__item" id="daily-budget-legend-actual">
              <span class="daily-budget-legend__swatch daily-budget-legend__swatch--actual" aria-hidden="true"></span>
              <span class="muted">Actual</span>
            </div>
          </div>

          <p id="daily-budget-empty" class="muted" hidden>Daily budget data not available yet.</p>

          <div id="daily-budget-meta" class="daily-budget-meta">
            <div id="daily-budget-confidence" class="chip">Confidence --</div>
          </div>

          <p class="muted">Refreshes every 60s. Uses local day boundaries.</p>
        </div>
      </details>
    </section>

    <section class="card panel hidden" id="usage-panel" data-panel="usage">
      <div class="card__header">
        <div>
          <p class="eyebrow">Usage</p>
          <h2>History & patterns</h2>
        </div>
      </div>

      <details class="settings-collapse" open>
        <summary>
          <h3 class="section-title">üìä Usage summary</h3>
          <span class="section-hint">Daily totals and patterns</span>
        </summary>
        <div class="collapse-content">
          <div id="usage-summary" class="usage-summary">
            <div class="summary-card">
              <span class="summary-label">Today</span>
              <span class="summary-value" id="usage-today">-- kWh</span>
            </div>
            <div class="summary-card">
              <span class="summary-label">This week</span>
              <span class="summary-value" id="usage-week">-- kWh</span>
            </div>
            <div class="summary-card">
              <span class="summary-label">This month</span>
              <span class="summary-value" id="usage-month">-- kWh</span>
            </div>
          </div>

          <h4>Weekday vs weekend average</h4>
          <div id="weekday-weekend-stats" class="usage-summary">
            <div class="summary-card">
              <span class="summary-label">Weekday avg</span>
              <span class="summary-value" id="usage-weekday-avg">-- kWh/day</span>
            </div>
            <div class="summary-card">
              <span class="summary-label">Weekend avg</span>
              <span class="summary-value" id="usage-weekend-avg">-- kWh/day</span>
            </div>
          </div>

          <h4>Typical usage by time of day</h4>
          <div id="hourly-pattern" class="hourly-pattern usage-list"></div>
          <p class="muted" id="hourly-pattern-meta">Average kWh per hour based on historical data.</p>
        </div>
      </details>

      <details class="settings-collapse">
        <summary>
          <h3 class="section-title">üìÖ Daily history</h3>
          <span class="section-hint">Last 14 days</span>
        </summary>
        <div class="collapse-content">
          <div id="daily-list" class="device-list usage-list" role="list"></div>
          <p id="daily-empty" class="muted" hidden>No daily totals yet.</p>
        </div>
      </details>

      <details class="settings-collapse">
        <summary>
          <h3 class="section-title">‚è±Ô∏è Hourly detail</h3>
          <span class="section-hint">Week view</span>
        </summary>
        <div class="collapse-content">
          <div class="hourly-nav">
            <button type="button" class="btn ghost" id="power-week-prev">Prev week</button>
            <div id="power-week-label" class="muted">This week</div>
            <button type="button" class="btn ghost" id="power-week-next">Next week</button>
          </div>
          <div class="usage-legend" id="power-legend">
            <div class="usage-legend__item">
              <span class="usage-legend__swatch" aria-hidden="true"></span>
              <span class="muted">Measured</span>
            </div>
            <div class="usage-legend__item">
              <span class="usage-legend__swatch usage-legend__swatch--warn" aria-hidden="true"></span>
              <span class="muted">Warning (over cap or unreliable)</span>
            </div>
          </div>
          <div id="power-list" class="device-list usage-list" role="list"></div>
          <p id="power-empty" class="muted" hidden>No power samples received yet. Wire the "Report power usage" Flow action.</p>
        </div>
      </details>

      <div class="list__footer">
        <button type="button" class="btn ghost" id="reset-stats-button">Reset all stats</button>
        <p class="muted">Hourly data kept for 30 days, daily totals for 1 year.</p>
      </div>
    </section>

    <section class="card panel" id="overview-panel" data-panel="overview">
      <div class="card__header">
        <div>
          <p class="eyebrow">Overview</p>
          <h2>Planned device states</h2>
        </div>
      </div>
      <div class="overview-stats">
        <div class="section-header">
          <h3 class="section-title">Quick stats</h3>
        </div>
        <div class="pill" id="plan-meta">Awaiting data‚Ä¶</div>
      </div>
      <div id="plan-list" class="device-list" role="list"></div>
      <p id="plan-empty" class="muted" hidden>No plan available yet. Send power data or refresh devices.</p>
      <div class="list__footer">
        <button type="button" class="btn secondary" id="plan-refresh-button">Refresh plan</button>
        <p class="muted">Plan is recalculated when power usage updates or when you refresh devices.</p>
      </div>
    </section>

    <section class="card panel hidden" id="advanced-panel" data-panel="advanced">
      <div class="card__header">
        <div>
          <p class="eyebrow">Advanced</p>
          <h2>Diagnostics</h2>
        </div>
      </div>
      <div class="form-grid">
        <label class="field checkbox-field">
          <input id="debug-topic-plan" data-debug-topic="plan" type="checkbox">
          <div>
            <span class="field__label">Plan engine</span>
            <small class="field__hint">Shedding, restore, and soft-limit decisions.</small>
          </div>
        </label>
        <label class="field checkbox-field">
          <input id="debug-topic-price" data-debug-topic="price" type="checkbox">
          <div>
            <span class="field__label">Price optimization</span>
            <small class="field__hint">Spot prices, tariffs, and price shaping.</small>
          </div>
        </label>
        <label class="field checkbox-field">
          <input id="debug-topic-daily-budget" data-debug-topic="daily_budget" type="checkbox">
          <div>
            <span class="field__label">Daily budget</span>
            <small class="field__hint">Daily plan and rollover.</small>
          </div>
        </label>
        <label class="field checkbox-field">
          <input id="debug-topic-devices" data-debug-topic="devices" type="checkbox">
          <div>
            <span class="field__label">Devices</span>
            <small class="field__hint">Device snapshots and Homey API interactions.</small>
          </div>
        </label>
        <label class="field checkbox-field">
          <input id="debug-topic-settings" data-debug-topic="settings" type="checkbox">
          <div>
            <span class="field__label">Settings</span>
            <small class="field__hint">Settings changes and housekeeping.</small>
          </div>
        </label>
        <p class="muted">Select only what you need. Debug logging stays enabled across restarts.</p>
      </div>
      <div class="section-header">
        <h3 class="section-title">Device cleanup</h3>
      </div>
      <div class="form-grid">
        <label class="field">
          <span class="field__label">Device</span>
          <select id="advanced-device-select"></select>
          <small class="field__hint">Removes PELS settings for this device only.</small>
        </label>
        <div class="inline-actions">
          <button type="button" class="btn ghost" id="advanced-device-clear">Clear device data</button>
          <button type="button" class="btn ghost" id="advanced-device-clear-unknown">Clear unknown devices</button>
        </div>
        <p class="muted">Clears modes, priorities, control flags, overshoot behavior, and price optimization for the selected device.</p>
        <p class="muted">Unknown devices are IDs stored in settings that are not in the latest device snapshot.</p>
      </div>
      <div class="section-header">
        <h3 class="section-title">Device log</h3>
      </div>
      <div class="form-grid">
        <label class="field">
          <span class="field__label">Homey device</span>
          <select id="advanced-api-device-select"></select>
          <small class="field__hint">Loads the raw device from the Homey API.</small>
        </label>
        <div class="inline-actions">
          <button type="button" class="btn ghost" id="advanced-api-device-refresh">Refresh list</button>
          <button type="button" class="btn ghost" id="advanced-api-device-log">Log device</button>
        </div>
        <p class="muted">Writes the selected device payload to the app logs for inspection.</p>
      </div>
    </section>

    <section class="card panel hidden" id="price-panel" data-panel="price">
      <div class="card__header">
        <div>
          <p class="eyebrow">Price</p>
          <h2>Electricity pricing</h2>
        </div>
        <div class="pill" id="price-status-badge">No data</div>
      </div>
      <div class="price-info">
        <p class="muted">Price-based optimization uses electricity spot prices and grid tariffs to shift energy-intensive tasks to cheaper hours.</p>
        <p class="muted">Totals include grid tariff, provider surcharge, consumption tax, Enova fee, VAT, and electricity support. Hover a price for the breakdown.</p>
      </div>
      
      <div class="toggle-row">
        <label class="toggle-label">
          <input type="checkbox" id="price-optimization-enabled" checked>
          <span>Enable price-based optimization</span>
        </label>
        <small class="field__hint">When disabled, device temperatures will not be adjusted based on electricity prices.</small>
      </div>
      
      <details class="settings-collapse">
        <summary>
          <h3 class="section-title">‚öôÔ∏è Price settings</h3>
          <span class="section-hint">Grid tariff & spot price configuration</span>
        </summary>
        <div class="collapse-content">
          <h4>Grid tariff</h4>
          <form id="nettleie-settings-form" class="form-grid">
            <label class="field">
              <span class="field__label">County</span>
              <select id="nettleie-fylke" name="nettleie_fylke">
                <option value="03">Oslo</option>
                <option value="11">Rogaland</option>
                <option value="15">M√∏re og Romsdal</option>
                <option value="18">Nordland</option>
                <option value="31">√òstfold</option>
                <option value="32">Akershus</option>
                <option value="33">Buskerud</option>
                <option value="34">Innlandet</option>
                <option value="39">Vestfold</option>
                <option value="40">Telemark</option>
                <option value="42">Agder</option>
                <option value="46">Vestland</option>
                <option value="50">Tr√∏ndelag</option>
                <option value="55">Troms</option>
                <option value="56">Finnmark</option>
              </select>
              <small class="field__hint">Your county for grid tariff lookup.</small>
            </label>
            <label class="field">
              <span class="field__label">Grid company</span>
              <select id="nettleie-company" name="nettleie_company">
                <option value="">-- Select grid company --</option>
              </select>
              <input id="nettleie-orgnr" name="nettleie_orgnr" type="hidden">
              <small class="field__hint">Select your grid company. List filtered by county.</small>
            </label>
            <label class="field">
              <span class="field__label">Tariff group</span>
              <select id="nettleie-tariffgruppe" name="nettleie_tariffgruppe">
                <option value="Husholdning">Household</option>
                <option value="Hytter og fritidshus">Cabin and holiday home</option>
              </select>
            </label>
            <div class="form__actions">
              <button type="button" class="btn ghost" id="nettleie-refresh-button">Refresh tariffs</button>
            </div>
          </form>
          
          <h4>Spot price</h4>
          <form id="price-settings-form" class="form-grid">
            <label class="field">
              <span class="field__label">Price area</span>
              <select id="price-area" name="price_area">
                <option value="NO1">NO1 - Oslo / East Norway</option>
                <option value="NO2">NO2 - Kristiansand / South Norway</option>
                <option value="NO3">NO3 - Trondheim / Central Norway</option>
                <option value="NO4">NO4 - Troms√∏ / North Norway (no VAT)</option>
                <option value="NO5">NO5 - Bergen / West Norway</option>
              </select>
              <small class="field__hint">Your electricity price area. Prices from <a href="https://www.hvakosterstrommen.no" target="_blank" rel="noopener">hvakosterstrommen.no</a></small>
            </label>
            <label class="field">
              <span class="field__label">Provider surcharge (√∏re/kWh, incl. VAT)</span>
              <input type="number" id="provider-surcharge" name="provider_surcharge" step="0.1" min="-100" max="100" value="0">
              <small class="field__hint">Your electricity provider's surcharge on top of the spot price, including VAT. Can be negative if you have a discount (check your contract).</small>
            </label>
            <label class="field">
              <span class="field__label">Price threshold (%)</span>
              <input type="number" id="price-threshold-percent" name="price_threshold_percent" step="1" min="5" max="50" value="25">
              <small class="field__hint">Hours below/above this % from average are considered cheap/expensive.</small>
            </label>
            <label class="field">
              <span class="field__label">Minimum price difference (√∏re/kWh)</span>
              <input type="number" id="price-min-diff-ore" name="price_min_diff_ore" step="1" min="0" max="100" value="0">
              <small class="field__hint">Skip optimization if savings are less than this. Avoids sacrificing comfort for minimal savings.</small>
            </label>
          </form>
        </div>
      </details>
      <div id="price-list" class="device-list" role="list"></div>
      <p id="price-empty" class="muted">No spot price data available. Configure a price source above to see electricity prices.</p>
      <div class="list__footer">
        <button type="button" class="btn secondary" id="price-refresh-button">Refresh prices</button>
      </div>

      <div id="price-optimization-section">
        <div class="section-header">
          <h3 class="section-title">Price optimization</h3>
        </div>
        <div class="price-info">
          <p class="muted">Adjust temperature based on electricity price. Deltas are applied to the current mode's target temperature.</p>
        </div>
        <div class="price-optimization-header">
          <p class="muted">Device</p>
          <div class="muted header-delta">üü¢ Cheap Œî</div>
          <div class="muted header-delta">üî¥ Expensive Œî</div>
        </div>
        <div id="price-optimization-list" class="device-list" role="list"></div>
        <div class="list__footer">
          <p class="muted">e.g., +5 during cheap hours boosts temp, -5 during expensive hours reduces it.</p>
        </div>
      </div>
      <p id="price-optimization-empty" class="muted" hidden>No devices with price optimization enabled. Enable it on the Devices tab.</p>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Device Detail Panel (slide-over) -->
  <div id="device-detail-overlay" class="overlay" hidden>
    <div id="device-detail-panel" class="slide-panel">
      <div class="slide-panel__header">
        <h2 id="device-detail-title">Device</h2>
        <button type="button" class="btn icon-btn" id="device-detail-close" aria-label="Close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      
      <div class="slide-panel__content">
        <section class="detail-section">
          <h3>Controls</h3>
          <div class="detail-controls">
            <label class="checkbox-field">
              <input type="checkbox" id="device-detail-managed">
              <span>Managed by PELS</span>
            </label>
            <p class="muted">Include this device in modes and optimization plans.</p>

            <label class="checkbox-field">
              <input type="checkbox" id="device-detail-controllable">
              <span>Capacity-based control</span>
            </label>
            <p class="muted">Allow PELS to adjust this device based on power capacity limits.</p>
            
            <label class="checkbox-field">
              <input type="checkbox" id="device-detail-price-opt">
              <span>Price-based control</span>
            </label>
            <p class="muted">Adjust temperature based on electricity price fluctuations.</p>

            <label class="field">
              <span class="field__label">When shedding</span>
              <select id="device-detail-overshoot">
                <option value="turn_off">Turn off</option>
                <option value="set_temperature">Set to temperature</option>
              </select>
              <small class="field__hint">Choose how PELS reacts when capacity is exceeded.</small>
            </label>
            <label class="field" id="device-detail-overshoot-temp-row" hidden>
              <span class="field__label">Minimum temperature (¬∞C)</span>
              <input type="number" id="device-detail-overshoot-temp" step="0.5" min="-20" max="40">
              <small class="field__hint">Set this instead of turning off when shedding.</small>
            </label>
          </div>
        </section>
        
        <section class="detail-section">
          <h3>Temperature per mode</h3>
          <p class="muted">Set the target temperature for each mode. PELS will set this when the mode is active.</p>
          <div id="device-detail-modes" class="detail-mode-list"></div>
        </section>
        
        <section class="detail-section" id="device-detail-delta-section">
          <h3>Price optimization deltas</h3>
          <p class="muted">Temperature adjustments applied during cheap/expensive electricity hours.</p>
          <div class="detail-deltas">
            <label class="field">
              <span class="field__label">üü¢ Cheap hours delta (¬∞C)</span>
              <input type="number" id="device-detail-cheap-delta" step="0.5" value="5">
              <small class="field__hint">Added to target during cheap hours (e.g. +5)</small>
            </label>
            <label class="field">
              <span class="field__label">üî¥ Expensive hours delta (¬∞C)</span>
              <input type="number" id="device-detail-expensive-delta" step="0.5" value="-5">
              <small class="field__hint">Added to target during expensive hours (e.g. -5)</small>
            </label>
          </div>
        </section>
      </div>
      
    </div>
  </div>

  <script src="/homey.js" data-origin="settings"></script>
  <script src="./script.js"></script>
</body>
</html>
